# AGENTS.md

<!-- AI-only configuration. Not intended for human users. See README.md and CONTRIBUTING.md for human docs. -->

## Hard Rules

1. **Never** modify `.github/workflows/` without explicit user request.
2. **Always** run `npm run format && npm run lint && npm run build && npm test` before marking work complete.
3. **Always** rebuild `dist/` via `npm run build` after any `src/` change — the compiled bundle is committed.
4. **Always** update `__tests__/index.test.js` when changing `src/index.js`.
5. **Always** export every function in `src/index.js` via named ESM exports (required for testability).
6. **Maintain** 80%+ coverage thresholds (branches, functions, lines, statements) — enforced by `vitest.config.js`.
7. **Never** log secrets or tokens; use pino structured logging.
8. **Commits** require Conventional Commits format with RAI attribution footer (enforced by commitlint via lefthook).

## Corrections to Common AI Assumptions

- **Test framework is vitest**, not Jest. Use `vitest` APIs (`vi`, `describe`, `test`, `expect`, `beforeEach`, `afterEach`).
- **Coverage threshold is 80%**, not 70%. Check `vitest.config.js` as source of truth.
- **No `test:coverage` script** exists. Coverage runs via `npm test` (`vitest run --coverage`).
- **`src/copilot-loader.js` is excluded** from coverage in `vitest.config.js` — do not add coverage tests for it.
- **Module system is ESM** (`"type": "module"` in package.json). Do not use `require()`.

## Architecture Constraints

- Entry point: `src/index.js` (ESM)
- Bundle: `dist/index.js` — generated by `@vercel/ncc`, must be committed
- Test mocks: `__tests__/mocks.js` — uses `vi.hoisted()` for mock setup before module imports
- SonarCloud: `sonar.tests=__tests__`, `sonar.sources=src`, coverage via `coverage/lcov.info`

## Security Invariants — Do Not Remove or Weaken

- `PROMPT_INJECTION_PATTERNS` in `src/index.js` — guards `runCopilot()` input
- `validateFilename()` — rejects absolute paths, `..`, lengths outside 1–255 chars
- `validateFile()` — enforces 1MB size limit (`MAX_FILE_SIZE`)
